AmCharts.AmExport=AmCharts.Class({construct:function(b,a,c){var d=this;d.DEBUG=false;d.chart=b;d.canvas=null;d.svgs=[];d.userCFG=a;d.buttonIcon="export.png";d.exportPNG=true;d.exportPDF=false;d.exportJPG=false;d.exportSVG=false;d.right=0;d.top=0;d.buttonRollOverColor="#EFEFEF";d.textRollOverColor="#CC0000";d.buttonTitle="Save chart as an image";d.buttonAlpha=0.75;d.imageFileName="amChart";d.imageBackgroundColor="#FFFFFF";if(c){d.init()}},toCoordinate:function(a){if(a===undefined){return"auto"}if(String(a).indexOf("%")!=-1){return a}else{return a+"px"}},init:function(){var f=this;var g=[];if(f.exportPNG){g.push("png")}if(f.exportPDF){g.push("pdf")}if(f.exportJPG){g.push("jpg")}if(f.exportSVG){g.push("svg")}var a=[];if(g.length==1){var h=g[0];a.push({format:h,iconTitle:f.buttonTitle,icon:f.chart.pathToImages+f.buttonIcon})}else{if(g.length>1){var d=[];for(var c=0;c<g.length;c++){d.push({format:g[c],title:g[c].toUpperCase()})}a.push({onclick:function(){},icon:f.chart.pathToImages+f.buttonIcon,items:d})}}var b=f.color;if(b===undefined){b=f.chart.color}var j=f.buttonColor;if(j===undefined){j="transparent"}f.cfg={menuTop:f.toCoordinate(f.top),menuLeft:f.toCoordinate(f.left),menuRight:f.toCoordinate(f.right),menuBottom:f.toCoordinate(f.bottom),menuItems:a,menuItemStyle:{backgroundColor:j,opacity:f.buttonAlpha,rollOverBackgroundColor:f.buttonRollOverColor,color:b,rollOverColor:f.textRollOverColor,paddingTop:"6px",paddingRight:"6px",paddingBottom:"6px",paddingLeft:"6px",marginTop:"0px",marginRight:"0px",marginBottom:"0px",marginLeft:"0px",textAlign:"left",textDecoration:"none",fontFamily:f.chart.fontFamily,fontSize:f.chart.fontSize+"px"},menuItemOutput:{backgroundColor:f.imageBackgroundColor,fileName:f.imageFileName,format:"png",output:"dataurlnewwindow",render:"browser",dpi:90,onclick:function(i,k,l){l.preventDefault();i.output(k)}},removeImagery:true};f.processing={buffer:[],drawn:0,timer:0};if(typeof(window.canvg)!="undefined"&&typeof(window.RGBColor)!="undefined"){f.cfg.menuItemOutput.render="canvg"}if(typeof(window.saveAs)!="undefined"){f.cfg.menuItemOutput.output="save"}if(AmCharts.isIE&&AmCharts.IEversion<10){f.cfg.menuItemOutput.output="dataurlnewwindow"}var e=f.userCFG;if(e){e.menuItemOutput=AmCharts.extend(f.cfg.menuItemOutput,e.menuItemOutput||{});e.menuItemStyle=AmCharts.extend(f.cfg.menuItemStyle,e.menuItemStyle||{});f.cfg=AmCharts.extend(f.cfg,e)}f.chart.AmExport=f;f.chart.addListener("rendered",function(){f.setup()});if(f.DEBUG){window.AmExport=f}},log:function(){console.log("AmExport: ",arguments)},setup:function(){var a=this;if(!AmCharts.isIE||(AmCharts.isIE&&AmCharts.IEversion>9)){a.generateButtons()}},generateBinaryArray:function(l){var h=l.length,e=new Uint8Array(h/4*3|0),g=0,k=0,m=[0,0],a=0,j=0,f,b,c,d=new Uint8Array([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51]);while(h--){b=l.charCodeAt(g++);f=d[b-43];if(f!==255&&f!==c){m[1]=m[0];m[0]=b;j=(j<<6)|f;a++;if(a===4){e[k++]=j>>>16;if(m[1]!==61){e[k++]=j>>>8}if(m[0]!==61){e[k++]=j}a=0}}}return e},generateBlob:function(e,c){var g=this,a=c!="image/svg+xml"?e.indexOf(",")+1:0,f=e.substring(0,a),d=e,b=new Blob();if(f.indexOf("base64")!=-1){d=g.generateBinaryArray(e.substring(a))}if(AmCharts.isIE&&AmCharts.IEversion<10){b.data=d;b.size=d.length;b.type=c;b.encoding="base64"}else{b=new Blob([d],{type:c})}return b},generatePDF:function(c){var f=this,b={output:function(){return""}},e=f.canvas.toDataURL("image/jpeg"),d=(f.canvas.width*25.4)/c.dpi,a=(f.canvas.height*25.4)/c.dpi;if(window.jsPDF){b=new jsPDF();if(b.addImage){b.addImage(e,"JPEG",0,0,d,a)}else{alert("Missing jsPDF plugin; Please add the 'addImage' plugin.")}}else{alert("Missing jsPDF lib; Don't forget to add the addImage plugin.")}return b},output:function(a,c){var d=this;a=AmCharts.extend(AmCharts.extend({},d.cfg.menuItemOutput),a||{});if(d.chart.prepareForExport){d.chart.prepareForExport()}function b(){var f=null;var e;if(a.format=="image/svg+xml"||a.format=="svg"){f=d.generateSVG();e=d.generateBlob(f,"image/svg+xml");if(a.output=="save"){saveAs(e,a.fileName+".svg")}else{if(a.output=="datastring"||a.output=="datauristring"||a.output=="dataurlstring"){e="data:image/svg+xml;base64,"+btoa(f)}else{if(a.output=="dataurlnewwindow"){window.open("data:image/svg+xml;base64,"+btoa(f))}else{if(a.output=="datauri"||a.output=="dataurl"){location.href="data:image/svg+xml;base64,"+btoa(f)}else{if(a.output=="datastream"){location.href="data:image/octet-stream;base64,"+f}}}}}if(c){c.apply(d,[e])}}else{if(a.format=="application/pdf"||a.format=="pdf"){f=d.generatePDF(a).output("dataurlstring");e=d.generateBlob(f,"application/pdf");if(a.output=="save"){saveAs(e,a.fileName+".pdf")}else{if(a.output=="datastring"||a.output=="datauristring"||a.output=="dataurlstring"){e=f}else{if(a.output=="dataurlnewwindow"){window.open(f)}else{if(a.output=="datauri"||a.output=="dataurl"){location.href=f}else{if(a.output=="datastream"){location.href=f.replace("application/pdf","application/octet-stream")}}}}}if(c){c.apply(d,[e])}}else{if(a.format=="image/png"||a.format=="png"){f=d.canvas.toDataURL("image/png");e=d.generateBlob(f,"image/png");if(a.output=="save"){saveAs(e,a.fileName+".png")}else{if(a.output=="datastring"||a.output=="datauristring"||a.output=="dataurlstring"){e=f}else{if(a.output=="dataurlnewwindow"){window.open(f)}else{if(a.output=="datauri"||a.output=="dataurl"){location.href=f}else{if(a.output=="datastream"){location.href=f.replace("image/png","image/octet-stream")}}}}}if(c){c.apply(d,[e])}}else{if(a.format=="image/jpeg"||a.format=="jpeg"||a.format=="jpg"){f=d.canvas.toDataURL("image/jpeg");e=d.generateBlob(f,"image/jpeg");if(a.output=="save"){saveAs(e,a.fileName+".jpg")}else{if(a.output=="datastring"||a.output=="datauristring"||a.output=="dataurlstring"){e=f}else{if(a.output=="dataurlnewwindow"){window.open(f)}else{if(a.output=="datauri"||a.output=="dataurl"){location.href=f}else{if(a.output=="datastream"){location.href=f.replace("image/jpeg","image/octet-stream")}}}}}if(c){c.apply(d,[e])}}}}}}return d.generateOutput(a,b)},polifySVG:function(a){var c=this;function b(g,d){var f=g.getElementsByTagName(d);var j=f.length;while(j--){if(c.cfg.removeImagery){f[j].parentNode.removeChild(f[j])}else{var l=document.createElement("img");var h=document.createElement("canvas");var e=h.getContext("2d");h.width=f[j].getAttribute("width");h.height=f[j].getAttribute("height");l.src=f[j].getAttribute("xlink:href");l.width=f[j].getAttribute("width");l.height=f[j].getAttribute("height");try{e.drawImage(l,0,0,l.width,l.height);datastring=h.toDataURL()}catch(k){datastring=l.src;c.log("Tainted canvas, reached browser CORS security; origin from imagery must be equal to the server!");throw new Error(k)}f[j].setAttribute("xlink:href",datastring)}}}if(AmCharts.IEversion==0){a.setAttribute("xmlns","http://www.w3.org/2000/svg");if(!c.cfg.removeImagery){a.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink")}}b(a,"pattern");b(a,"image");c.svgs.push(a);return a},generateSVG:function(){var e=this;var b=document.createElement("svg");b.setAttribute("xmlns","http://www.w3.org/2000/svg");b.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");for(var a=0;a<e.processing.buffer.length;a++){var d=document.createElement("g"),c=e.processing.buffer[a];c[0].setAttribute("xmlns","http://www.w3.org/2000/svg");c[0].setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");d.setAttribute("transform","translate("+c[1].x+","+c[1].y+")");d.appendChild(c[0]);b.appendChild(d)}return new XMLSerializer().serializeToString(b)},generateOutput:function(l,p){var k=this,a=[],o=[],d=document.createElement("canvas"),c=d.getContext("2d"),f={y:0,x:0},a=k.chart.div.getElementsByTagName("svg");for(var j=0;j<a.length;j++){o.push(a[j])}if(k.chart.legend&&k.chart.legend.position=="outside"){k.chart.legend.container.container.externalLegend=true;o.push(k.chart.legend.container.container);if(k.cfg.legendPosition=="left"){f.x=k.chart.legend.div.offsetWidth}else{if(k.cfg.legendPosition=="top"){f.y=k.chart.legend.div.offsetHeight}else{if(typeof k.cfg.legendPosition=="object"){f.y=k.cfg.legendPosition.chartTop;f.x=k.cfg.legendPosition.chartLeft}}}}k.processing.buffer=[];k.processing.drawn=0;k.canvas=d;k.svgs=[];var m={x:0,y:0};for(var j=0;j<o.length;j++){var n=o[j].parentNode,r=Number(n.style.left.slice(0,-2)),q=Number(n.style.top.slice(0,-2)),h=k.polifySVG(o[j].cloneNode(true)),g=AmCharts.extend({},f);if(o[j].externalLegend){if(k.cfg.legendPosition=="right"){f.y=0;f.x=k.chart.divRealWidth}else{if(k.cfg.legendPosition=="bottom"){f.y=q?q:f.y}else{if(typeof k.cfg.legendPosition=="object"){f.x=k.cfg.legendPosition.left;f.y=k.cfg.legendPosition.top}else{f.x=0;f.y=0}}}}else{if(n.style.position=="relative"){f.x=r?r:f.x;f.y=q?q:f.y}else{f.x=r+m.x;f.y=q+m.y}}k.processing.buffer.push([h,AmCharts.extend({},f)]);if(q&&r){f=g}else{f.y+=q?0:n.offsetHeight}if(n.style.position=="absolute"&&n.getAttribute("class")=="amChartsLegend"){m.y+=n.parentNode.offsetHeight}}d.id=AmCharts.getUniqueId();d.width=k.chart.divRealWidth;d.height=k.chart.divRealHeight;if(k.chart.legend&&k.chart.legend.position=="outside"){if(["left","right"].indexOf(k.cfg.legendPosition)!=-1){d.width+=k.chart.legend.div.offsetWidth}else{if(typeof k.cfg.legendPosition=="object"){d.width+=k.cfg.legendPosition.width;d.height+=k.cfg.legendPosition.height}else{d.height+=k.chart.legend.div.offsetHeight}}}var e={width:false,height:false};if(k.chart.periodSelector){if(["left","right"].indexOf(k.chart.periodSelector.position)!=-1){d.width-=k.chart.periodSelector.div.offsetWidth+16;e.width=true}else{d.height-=k.chart.periodSelector.div.offsetHeight;e.height=true}}if(k.chart.dataSetSelector){if(["left","right"].indexOf(k.chart.dataSetSelector.position)!=-1){if(!e.width){d.width-=k.chart.dataSetSelector.div.offsetWidth+16}}else{d.height-=k.chart.dataSetSelector.div.offsetHeight}}if(l.backgroundColor||l.format=="image/jpeg"){c.fillStyle=l.backgroundColor||"#FFFFFF";c.fillRect(0,0,d.width,d.height)}function b(){var s,i,u,t;if(k.processing.buffer.length==k.processing.drawn||l.format=="svg"){return p()}else{i=k.processing.buffer[k.processing.drawn];t=new XMLSerializer().serializeToString(i[0]);u=i[1];if(l.render=="browser"){s=new Image();s.id=AmCharts.getUniqueId();t="data:image/svg+xml;base64,"+btoa(t);s.onload=function(){c.drawImage(this,i[1].x,i[1].y);k.processing.drawn++;b()};s.onerror=function(){c.drawImage(this,i[1].x,i[1].y);k.processing.drawn++;b()};s.src=t;if(s.complete||typeof(s.complete)=="undefined"||s.complete===undefined){s.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";s.src=t}}else{if(l.render=="canvg"){canvg(d,t,{offsetX:u.x,offsetY:u.y,ignoreMouse:true,ignoreAnimation:true,ignoreDimensions:true,ignoreClear:true,renderCallback:function(){k.processing.drawn++;b()}})}}}}return b()},generateButtons:function(){var c=this,a=0;if(c.div){div=c.div;div.innerHTML=""}else{div=document.createElement("div"),c.div=div}function b(j){var h=document.createElement("ul");h.setAttribute("style","list-style: none; margin: 0; padding: 0;");for(var e=0;e<j.length;e++){var l=document.createElement("li"),f=document.createElement("img"),k=document.createElement("a"),m=j[e],d=null,g=AmCharts.extend(AmCharts.extend({},c.cfg.menuItemStyle),j[e]);m=AmCharts.extend(AmCharts.extend({},c.cfg.menuItemOutput),m);if(m.icon){f.alt="";f.src=m.icon;f.setAttribute("style","margin: 0 auto;border: none;outline: none");if(m.iconTitle){f.title=m.iconTitle}k.appendChild(f)}k.href="#";if(m.title){f.setAttribute("style","margin: 0px 5px;");k.innerHTML+=m.title}k.setAttribute("style","display: block;");AmCharts.extend(k.style,g);k.onclick=m.onclick.bind(k,c,m);l.appendChild(k);if(m.items){d=b(m.items);l.appendChild(d);l.onmouseover=function(){d.style.display="block"};l.onmouseout=function(){d.style.display="none"};d.style.display="none"}h.appendChild(l);k.onmouseover=function(){this.style.backgroundColor=g.rollOverBackgroundColor;this.style.color=g.rollOverColor;this.style.borderColor=g.rollOverBorderColor};k.onmouseout=function(){this.style.backgroundColor=g.backgroundColor;this.style.color=g.color;this.style.borderColor=g.borderColor}}a++;return h}div.setAttribute("style","position: absolute;top:"+c.cfg.menuTop+";right:"+c.cfg.menuRight+";bottom:"+c.cfg.menuBottom+";left:"+c.cfg.menuLeft+";");div.setAttribute("class","amExportButton");div.appendChild(b(c.cfg.menuItems));c.chart.containerDiv.appendChild(div)}});